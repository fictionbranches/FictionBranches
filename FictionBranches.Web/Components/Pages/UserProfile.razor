@page "/fb/user/{Id}"

@inject IDbContextFactory<ApplicationDbContext> DbContextFactory
@inject IOptionsMonitor<FictionBranchesOptions> FbConfig
@inject RootEpisodeCache RootEpisodeCache

@if (user is null)
{
    <NotFound Item="@Id" />
}
else
{
    <PageTitle>@user.Author's profile</PageTitle>
    <h1>@user.Author's profile</h1>
    @if (user.Level > 1)
    {
        <p>Fiction Branches @(user.Level > 10 ? "admin" : "moderator")</p>
    }
    <p>Member since @user.Date</p>

    <hr/>
    <div class="fbrawmarkdown">@user.Bio</div>
    <hr/>

    <p>
        @if (Comments is null)
        {
            <a href="/fb/user/@user.Id?comments">Recent Comments</a>
        }
        else
        {
            <a href="/fb/user/@user.Id">Recent Episodes</a>
        }
        <br/>
        @if (!isFirstPage)
        {
            <a href="@($"/fb/user/{user.Id}?page={page - 1}{(Comments is not null ? "&comments" : "")}")">Previous</a>
        }
        @if (!isFirstPage && !isLastPage)
        {
            <text>&nbsp;</text>
        }
        @if (!isLastPage)
        {
            <a href="@($"/fb/user/{user.Id}?page={page + 1}{(Comments is not null ? "&comments" : "")}")">Next</a>
        }
    </p>
    
    
    @if (Comments is null)
    {
        // show recent episodes
        <table class="table table-striped">
            <thead>
            <tr>
                <th scope="col">Episode</th>
                <th scope="col">Date</th>
                <th scope="col">Story</th>
                <th scope="col">Depth</th>
            </tr>
            </thead>
            <tbody>
                @foreach (var episode in user.FbepisodeAuthors.Take(pageSize))
                {
                    <tr>
                        <td><EpisodeLink Episode="episode" ShowTitleIfDifferent="true" /></td>
                        <td>@episode.Date</td>
                        <td><EpisodeLink Episode="RootEpisodeCache.GetEpisodeFromNewMap(episode.Newmap)" /></td>
                        <td>@episode.Newmap?.Split('B')?.Length</td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        // show recent comments
         @foreach (var comment in user.FbcommentUsers)
         {
             <CommentDisplay Comment="comment" ShowEpisode="true" />
         }
    }
}


@code {
    [Parameter] public required string Id { get; init; }

    [SupplyParameterFromQuery] public string? Comments { get; init; }

    [SupplyParameterFromQuery] public int? Page { get; init; }

    private Fbuser? user;
    private int page;
    private int pageSize;
    private bool isFirstPage;
    private bool isLastPage;

    protected override void OnInitialized()
    {
        base.OnInitialized();

        page = int.Max(Page ?? -1, 1);
        pageSize = FbConfig.CurrentValue.PageSize;

        isFirstPage = page == 1;

        using var db = DbContextFactory.CreateDbContext();
        
        user = db.Fbusers
            .FirstOrDefault(e => e.Id.ToLower() == Id.ToLower());

        if (user is null)
        {
            return;
        }

        if (Comments is null)
        {
            // show recent episodes
            user.FbepisodeAuthors = db.Fbepisodes
                .Where(e => e.AuthorId == user.Id)
                .OrderByDescending(e => e.Date)
                .Skip(pageSize * (page-1))
                .Take(pageSize+1)
                .ToList();

            isLastPage = user.FbepisodeAuthors.Count <= pageSize;
        }
        else
        {
            // show recent comments
            user.FbcommentUsers = db.Fbcomments
                .Include(e => e.EpisodeGenerated)
                .Where(e => e.UserId == user.Id)
                .OrderByDescending(e => e.Date)
                .Skip(pageSize * (page-1))
                .Take(pageSize+1)
                .ToList();
            isLastPage = user.FbcommentUsers.Count <= pageSize;

        }
    }

}