@inherits LayoutComponentBase

@inject UserManager<Fbuser> UserManager
@inject SignInManager<Fbuser> SignInManager
@inject IHttpContextAccessor HttpContextAccessor
@inject IdentityRedirectManager RedirectManager

<CascadingValue Value="@this">
    
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container">
            <a href="/">
                <img src="/fblogo.png" alt="Fiction Branches"/>
            </a>
            <!-- Mobile toggle button -->
            <button class="btn btn-outline-secondary btn-lg d-lg-none ms-auto"
                    type="button"
                    data-bs-toggle="offcanvas"
                    data-bs-target="#sidebar"
                    aria-controls="sidebar"
                    aria-label="Open sidebar">
                <i class="bi bi-list"></i>
            </button>
        </div>
    </nav>

    <div class="container py-4">
        <div class="row g-2">
            <!-- Main content -->
            <main class="col-12 col-lg-8 order-2 order-lg-1">
                @Body
            </main>

            <!-- Sidebar -->
            <aside class="col-12 col-lg-4 order-1 order-lg-2">
                <!-- Mobile offcanvas -->
                <div class="offcanvas offcanvas-end d-lg-none"
                     tabindex="-1"
                     id="sidebar"
                     aria-labelledby="sidebarLabel">
                    <div class="offcanvas-header">
                        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
                    </div>
                    <div id="sidebar-content-mobile" class="offcanvas-body">@* poplated by javascript *@</div>
                </div>

                <!-- Desktop static sidebar -->
                <div id="sidebar-content-desktop" class="d-none d-lg-block position-sticky" style="top: 1rem;">
                    <div>
                        <SidebarSection>
                            @if (user is null)
                            {
                                <p><a href="/fb/account/login">Log in</a></p>
                            }
                            else
                            {
                                <p>Logged in as @username</p>
                                @if (user.Level >= 100)
                                {
                                    <p>You are an Admin</p>
                                }
                                else if (user.Level >= 10)
                                {
                                    <p>You are a Moderator</p>
                                }
                                else
                                {
                                    <p>You are a User</p>
                                }
                            }
                        </SidebarSection>
                        <SectionOutlet SectionName="@Names.AdditionalSidebar" />
                    </div>
                </div>
            </aside>
        </div>
    </div>
    
</CascadingValue>

<script>
    const original = document.getElementById('sidebar-content-desktop');
    const clone = document.getElementById('sidebar-content-mobile');
    if (original && clone) {
        clone.innerHTML = original.innerHTML;
    }
</script>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

@code {
    
    private Fbuser? user = null;
    private string? username;

    protected override async Task OnInitializedAsync()
    {
        user = await UserManager.GetUserAsync(HttpContextAccessor.HttpContext.User);
        if (user != null)
            username = await UserManager.GetUserNameAsync(user);
    }
    
}